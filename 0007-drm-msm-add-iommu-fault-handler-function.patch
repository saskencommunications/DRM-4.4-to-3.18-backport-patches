From 216c1815c88078783e308b0607d749eeb5f00a2c Mon Sep 17 00:00:00 2001
From: Yajun Li <yajunl@codeaurora.org>
Date: Thu, 9 Jun 2016 21:55:53 +0800
Subject: [PATCH 07/10] drm:msm add iommu fault handler function

Change-Id: Ia2486fe167b889633ea4fb4c42601791efda133c
Signed-off-by: Yajun Li <yajunl@codeaurora.org>
---
 drivers/gpu/drm/msm/msm_smmu.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/drivers/gpu/drm/msm/msm_smmu.c b/drivers/gpu/drm/msm/msm_smmu.c
index ad7c790..b98b40e 100644
--- a/drivers/gpu/drm/msm/msm_smmu.c
+++ b/drivers/gpu/drm/msm/msm_smmu.c
@@ -31,6 +31,16 @@ struct msm_smmu_domain {
 #define to_msm_smmu(x) container_of(x, struct msm_smmu, base)
 #define msm_smmu_to_client(smmu) (&smmu->client)
 
+
+static int msm_smmu_fault_handler(struct iommu_domain *iommu, struct device *dev,
+		unsigned long iova, int flags, void *arg)
+{
+
+	dev_info(dev, "%s: iova=0x%08lx, flags=0x%x, iommu=%p\n", __func__, iova, flags, iommu);
+	return 0;
+}
+
+
 static int _msm_smmu_create_mapping(struct msm_smmu_client *client,
 	const struct msm_smmu_domain *domain);
 
@@ -299,6 +309,7 @@ struct msm_mmu *msm_smmu_new(struct device *dev,
 {
 	struct msm_smmu *smmu;
 	struct device *client_dev;
+	struct msm_smmu_client *client;
 
 	smmu = kzalloc(sizeof(*smmu), GFP_KERNEL);
 	if (!smmu)
@@ -311,6 +322,9 @@ struct msm_mmu *msm_smmu_new(struct device *dev,
 	smmu->client_dev = client_dev;
 	msm_mmu_init(&smmu->base, dev, &funcs);
 
+	client = msm_smmu_to_client(smmu);
+	iommu_set_fault_handler(client->mmu_mapping->domain, msm_smmu_fault_handler, dev);
+
 	return &smmu->base;
 }
 
-- 
1.9.1

