From 892d50963046df1e0e671c90004dd3da7165550a Mon Sep 17 00:00:00 2001
From: Adrian Salido-Moreno <adrianm@codeaurora.org>
Date: Thu, 20 Aug 2015 15:50:25 -0700
Subject: [PATCH 33/41] drm/kms: remove compilation of hdcp_hdmi

Remove hdcp_hdmi driver compilation from drm hdmi.

Change-Id: I788747750e7f586c58fe0d0bd3b5a4d223adfb96
Signed-off-by: Jin Li <jinl@codeaurora.org>
---
 drivers/gpu/drm/msm/Kconfig            | 7 +++++++
 drivers/gpu/drm/msm/Makefile           | 3 ++-
 drivers/gpu/drm/msm/hdmi/hdmi.c        | 6 ++++++
 drivers/gpu/drm/msm/hdmi/hdmi_bridge.c | 4 ++++
 4 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/msm/Kconfig b/drivers/gpu/drm/msm/Kconfig
index 462f818..ecb383c 100644
--- a/drivers/gpu/drm/msm/Kconfig
+++ b/drivers/gpu/drm/msm/Kconfig
@@ -63,3 +63,10 @@ config DRM_MSM_DSI_PLL
 	help
 	  Choose this option to enable DSI PLL driver which provides DSI
 	  source clocks under common clock framework.
+
+config DRM_MSM_HDCP
+	tristate "HDCP for MSM DRM"
+	depends on DRM_MSM
+	default n
+	help
+	  DRM/KMS driver for HDCP support.
diff --git a/drivers/gpu/drm/msm/Makefile b/drivers/gpu/drm/msm/Makefile
index 0c592cf..63b13f9 100644
--- a/drivers/gpu/drm/msm/Makefile
+++ b/drivers/gpu/drm/msm/Makefile
@@ -6,7 +6,6 @@ msm-y := \
 	hdmi/hdmi_audio.o \
 	hdmi/hdmi_bridge.o \
 	hdmi/hdmi_connector.o \
-	hdmi/hdmi_hdcp.o \
 	hdmi/hdmi_i2c.o \
 	hdmi/hdmi_phy_8960.o \
 	hdmi/hdmi_phy_8x60.o \
@@ -47,6 +46,8 @@ msm-y += adreno/adreno_device.o \
 	adreno/a4xx_gpu.o
 endif
 
+msm-$(CONFIG_DRM_MSM_HDCP) += hdmi/hdmi_hdcp.o
+
 msm-$(CONFIG_DRM_MSM_MDP4) += \
 	mdp/mdp4/mdp4_crtc.o \
 	mdp/mdp4/mdp4_dtv_encoder.o \
diff --git a/drivers/gpu/drm/msm/hdmi/hdmi.c b/drivers/gpu/drm/msm/hdmi/hdmi.c
index dd1ea35..579674f 100644
--- a/drivers/gpu/drm/msm/hdmi/hdmi.c
+++ b/drivers/gpu/drm/msm/hdmi/hdmi.c
@@ -54,9 +54,11 @@ static irqreturn_t hdmi_irq(int irq, void *dev_id)
 	/* Process DDC: */
 	hdmi_i2c_irq(hdmi->i2c);
 
+#ifdef CONFIG_DRM_MSM_HDCP
 	/* Process HDCP: */
 	if (hdmi->hdcp_ctrl)
 		hdmi_hdcp_irq(hdmi->hdcp_ctrl);
+#endif
 
 	/* TODO audio.. */
 
@@ -75,7 +77,9 @@ static void hdmi_destroy(struct hdmi *hdmi)
 		flush_workqueue(hdmi->workq);
 		destroy_workqueue(hdmi->workq);
 	}
+#ifdef CONFIG_DRM_MSM_HDCP
 	hdmi_hdcp_destroy(hdmi);
+#endif
 	if (phy)
 		phy->funcs->destroy(phy);
 
@@ -228,11 +232,13 @@ static struct hdmi *hdmi_init(struct platform_device *pdev)
 		goto fail;
 	}
 
+#ifdef CONFIG_DRM_MSM_HDCP
 	hdmi->hdcp_ctrl = hdmi_hdcp_init(hdmi);
 	if (IS_ERR(hdmi->hdcp_ctrl)) {
 		dev_warn(&pdev->dev, "failed to init hdcp: disabled\n");
 		hdmi->hdcp_ctrl = NULL;
 	}
+#endif
 
 	return hdmi;
 
diff --git a/drivers/gpu/drm/msm/hdmi/hdmi_bridge.c b/drivers/gpu/drm/msm/hdmi/hdmi_bridge.c
index 92b69ae..2295644 100644
--- a/drivers/gpu/drm/msm/hdmi/hdmi_bridge.c
+++ b/drivers/gpu/drm/msm/hdmi/hdmi_bridge.c
@@ -105,8 +105,10 @@ static void hdmi_bridge_pre_enable(struct drm_bridge *bridge)
 
 	hdmi_set_mode(hdmi, true);
 
+#ifdef CONFIG_DRM_MSM_HDCP
 	if (hdmi->hdcp_ctrl)
 		hdmi_hdcp_on(hdmi->hdcp_ctrl);
+#endif
 }
 
 static void hdmi_bridge_enable(struct drm_bridge *bridge)
@@ -123,8 +125,10 @@ static void hdmi_bridge_post_disable(struct drm_bridge *bridge)
 	struct hdmi *hdmi = hdmi_bridge->hdmi;
 	struct hdmi_phy *phy = hdmi->phy;
 
+#ifdef CONFIG_DRM_MSM_HDCP
 	if (hdmi->hdcp_ctrl)
 		hdmi_hdcp_off(hdmi->hdcp_ctrl);
+#endif
 
 	DBG("power down");
 	hdmi_set_mode(hdmi, false);
-- 
2.8.2

