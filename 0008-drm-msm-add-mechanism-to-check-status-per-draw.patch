From e63f5af35e5de828e6facc43a4e325257632667e Mon Sep 17 00:00:00 2001
From: Yajun Li <yajunl@codeaurora.org>
Date: Sat, 11 Jun 2016 04:20:38 +0800
Subject: [PATCH 08/10] drm:msm add mechanism to check status per draw

Change-Id: Ib832f1814ee2fb04e2fd0e3f319c1e7ca1aed9ee
Signed-off-by: Yajun Li <yajunl@codeaurora.org>
---
 drivers/gpu/drm/msm/msm_drv.c | 4 ++++
 drivers/gpu/drm/msm/msm_drv.h | 1 +
 drivers/gpu/drm/msm/msm_gpu.c | 5 ++++-
 drivers/gpu/drm/msm/msm_gpu.h | 2 +-
 4 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/msm/msm_drv.c b/drivers/gpu/drm/msm/msm_drv.c
index 62b9c47..21aca33 100644
--- a/drivers/gpu/drm/msm/msm_drv.c
+++ b/drivers/gpu/drm/msm/msm_drv.c
@@ -374,6 +374,10 @@ static int msm_load(struct drm_device *dev, unsigned long flags)
 	INIT_WORK(&priv->vblank_ctrl.work, vblank_ctrl_worker);
 	spin_lock_init(&priv->vblank_ctrl.lock);
 
+#ifdef MSM_FORCE_SUBMIT
+	priv->force_submit = true;
+#endif
+
 	drm_mode_config_init(dev);
 
 	platform_set_drvdata(pdev, dev);
diff --git a/drivers/gpu/drm/msm/msm_drv.h b/drivers/gpu/drm/msm/msm_drv.h
index 9ebd6f5..69be2a0 100644
--- a/drivers/gpu/drm/msm/msm_drv.h
+++ b/drivers/gpu/drm/msm/msm_drv.h
@@ -156,6 +156,7 @@ struct msm_drm_private {
 	} vram;
 
 	struct msm_vblank_ctrl vblank_ctrl;
+	bool force_submit;
 };
 
 struct msm_format {
diff --git a/drivers/gpu/drm/msm/msm_gpu.c b/drivers/gpu/drm/msm/msm_gpu.c
index aed9f37..f755b4b 100644
--- a/drivers/gpu/drm/msm/msm_gpu.c
+++ b/drivers/gpu/drm/msm/msm_gpu.c
@@ -511,7 +511,8 @@ int msm_gpu_submit(struct msm_gpu *gpu, struct msm_gem_submit *submit,
 
 	inactive_cancel(gpu);
 
-	list_add_tail(&submit->node, &gpu->submit_list);
+	if (!priv->force_submit)
+		list_add_tail(&submit->node, &gpu->submit_list);
 
 	msm_rd_dump_submit(submit);
 
@@ -544,6 +545,8 @@ int msm_gpu_submit(struct msm_gpu *gpu, struct msm_gem_submit *submit,
 	}
 
 	ret = gpu->funcs->submit(gpu, submit, ctx);
+	if (priv->force_submit && gpu->funcs->idle(gpu))
+		DRM_ERROR("%s: hardware hang\n", __func__);
 	priv->lastctx = ctx;
 
 	hangcheck_timer_reset(gpu);
diff --git a/drivers/gpu/drm/msm/msm_gpu.h b/drivers/gpu/drm/msm/msm_gpu.h
index 9c22793..2accfc0 100644
--- a/drivers/gpu/drm/msm/msm_gpu.h
+++ b/drivers/gpu/drm/msm/msm_gpu.h
@@ -49,7 +49,7 @@ struct msm_gpu_funcs {
 	int (*submit)(struct msm_gpu *gpu, struct msm_gem_submit *submit,
 			struct msm_file_private *ctx);
 	void (*flush)(struct msm_gpu *gpu);
-	void (*idle)(struct msm_gpu *gpu);
+	int (*idle)(struct msm_gpu *gpu);
 	irqreturn_t (*irq)(struct msm_gpu *irq);
 	uint32_t (*last_fence)(struct msm_gpu *gpu);
 	void (*recover)(struct msm_gpu *gpu);
-- 
1.9.1

